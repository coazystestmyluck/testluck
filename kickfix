local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local Gui = Players.LocalPlayer.PlayerGui

-- ================= EQUIP FUNCTION =================
local function equipAndActivate()
    local limbWeights = Players.LocalPlayer.Backpack:FindFirstChild("Limb Weights")
    if limbWeights then
        limbWeights.Parent = Players.LocalPlayer.Character
        limbWeights:Activate()
        limbWeights.Parent = Players.LocalPlayer.Backpack
    end
end

-- ================= TIME CONTROL =================
local function getEST()
    local utc = os.date("!*t")
    local estOffset = -4
    local estHour = (utc.hour + estOffset) % 24
    return estHour, utc.min, utc.sec
end

local allowedHours = {
    [1] = true, [8] = true, [13] = true, [19] = true,
}

local function inAllowedWindow()
    local h,m,s = getEST()
    return allowedHours[h] and ((m > 0) or (m == 0 and s >= 10)) and ((m < 59) or (m == 59 and s <= 10))
end

local function getNextAllowed()
    local h,m,s = getEST()
    local curSecs = h*3600 + m*60 + s
    local soonestDiff = math.huge
    local nextHour = nil
    for hour in pairs(allowedHours) do
        local targetSecs = hour*3600 + 10
        if targetSecs <= curSecs then targetSecs = targetSecs + 86400 end
        local diff = targetSecs - curSecs
        if diff < soonestDiff then
            soonestDiff = diff
            nextHour = hour
        end
    end
    return nextHour, soonestDiff
end

local function to12Hour(h, m, s)
    local suffix = "AM"
    if h >= 12 then suffix = "PM" end
    local hour12 = h % 12
    if hour12 == 0 then hour12 = 12 end
    return string.format("%d:%02d:%02d %s", hour12, m, s, suffix)
end

task.delay(1, function()
    if not inAllowedWindow() then
        local h,m,s = getEST()
        local nextH, diff = getNextAllowed()
        print("Not allowed time. Current EST: "..to12Hour(h,m,s)..". Next allowed: "..to12Hour(nextH,0,10).." ("..diff.."s away)")
    end
end)

-- ================= SCRIPT ACTIONS =================
local upgradePositions = {
    karate = CFrame.new(-582.616455, 49.399929, -584.535034),
    muayThai = CFrame.new(891.39679, 28.1500301, 21.1374512),
    kungFu = CFrame.new(-1106.40442, 47.7230835, 129.619614),
    cons = CFrame.new(-2185.30005, -79.1400757, 269.199982),
}

local function fireUpgradeClick(upgradeName)
    local position = upgradePositions[upgradeName]
    if not position then return end
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and (obj.Position - position.Position).Magnitude < 5 then
            local parent = obj.Parent
            if parent then
                local clickDetector = parent:FindFirstChild("ClickDetector")
                if clickDetector then
                    fireclickdetector(clickDetector)
                    return
                end
            end
        end
    end
end

local function clickChoiceA()
    local dialogueGui = Gui:FindFirstChild("DialogueGUI")
    local dialogueT = dialogueGui and dialogueGui:FindFirstChild("DialogueT")
    local choiceFrame = dialogueT and dialogueT:FindFirstChild("Choice")
    local choiceButton = choiceFrame and choiceFrame:FindFirstChild("a")
    if choiceButton and choiceButton.Visible then
        for _, connection in ipairs(getconnections(choiceButton.MouseButton1Click)) do
            connection.Function()
        end
    end
end

local buttonClicked = false
local function triggerReplayButton()
    local button = Gui:FindFirstChild("ContractGUI")
    if button then
        button = button:FindFirstChild("Selection")
        button = button and button:FindFirstChild("SF")
        button = button and button:FindFirstChild("Holder")
        button = button and button:FindFirstChild("Kyokushin Dojo Three")
    end
    if button and button.Visible and not buttonClicked then
        for _, connection in ipairs(getconnections(button.MouseButton1Click)) do
            connection.Function()
        end
        buttonClicked = true
    end
end

local function z()
    local button = Gui:FindFirstChild("ContractGUI")
    button = button and button:FindFirstChild("Selection")
    button = button and button:FindFirstChild("Select")
    if button and button.Visible then
        for _, connection in ipairs(getconnections(button.MouseButton1Click)) do
            connection.Function()
        end
    end
end

local function zstart()
    local button = Gui:FindFirstChild("ContractGUI")
    button = button and button:FindFirstChild("Main")
    button = button and button:FindFirstChild("Raid")
    button = button and button:FindFirstChild("Start")
    if button and button.Visible then
        for _, connection in ipairs(getconnections(button.MouseButton1Click)) do
            connection.Function()
        end
    end
end

-- ================= PLAY BUTTON SPAM FUNCTION =================
local function waitForPlayButton()
    local player = Players.LocalPlayer
    local hrpExists = false
    local loadMenu = Gui:WaitForChild("LoadMenu")
    local mainFrame = loadMenu:WaitForChild("MainFrame")
    local playButton = mainFrame:WaitForChild("Play")

    while not hrpExists do
        local character = player.Character
        local hrp = character and character:FindFirstChild("HumanoidRootPart")
        if hrp then
            hrpExists = true
            print("HumanoidRootPart detected, stopping Play button clicks.")
            break
        end
        if playButton then
            for _, connection in ipairs(getconnections(playButton.MouseButton1Click)) do
                connection.Function()
            end
            print("Clicked Play button.")
        end
        task.wait(0.5)
    end
end

-- ================= LOOP =================
task.spawn(function()
    while true do
        if inAllowedWindow() then
            print("Allowed time window, executing script...")

            spawn(function()
                while inAllowedWindow() do
                    triggerReplayButton()
                    task.wait(1)
                end
            end)

            spawn(function()
                while inAllowedWindow() do
                    z()
                    task.wait(1)
                end
            end)

            spawn(function()
                while inAllowedWindow() do
                    zstart()
                    task.wait(1)
                end
            end)

            -- âœ… Wait for Play button only if HRP doesn't exist
            waitForPlayButton()
            fireUpgradeClick("cons")
            task.wait(2)
            clickChoiceA()
            task.wait(2)
            clickChoiceA()
            zstart()
        else
            -- NOT ALLOWED TIME
            if game.PlaceId == 4878988249 then
                -- Wait and spam Play button until HRP exists
                waitForPlayButton()
                
                -- After HRP exists, proceed with macro
                local player = Players.LocalPlayer
                task.wait(60) -- wait before checking macro button
                local button = player.PlayerGui.MainGui.MacroButtonF.SelectionF.Start.Title.ContentText

                if button == "START" then
                    local trainingName = "Striking Power Training"
                    if player.Name == "flextall1" or player.Name == "Rykujin" then
                        trainingName = "Strike Speed Training"
                    end

                    local butt = player.PlayerGui.MainGui.MacroButtonF.SelectionF.SF.Holder:FindFirstChild(trainingName)
                    if butt then
                        firesignal(butt.MouseButton1Up)
                        equipAndActivate()
                    end

                    task.wait(2)
                    local startButton = player.PlayerGui.MainGui.MacroButtonF.SelectionF:FindFirstChild("Start")
                    if startButton then
                        firesignal(startButton.MouseButton1Up)
                    end
                end
            else
                TeleportService:Teleport(4878988249, Players.LocalPlayer)
            end
        end
        task.wait(1)
    end
end)
